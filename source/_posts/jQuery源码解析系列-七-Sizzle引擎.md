---
title: jQueryæºç è§£æç³»åˆ—(ä¸ƒ) -Sizzleå¼•æ“
date: 2019-04-19 07:27:52
tags: [jQuery, ts]
categories: [frontend]
---


ç»è¿‡äº†å‰`å…­`ç¯‡æ–‡ç« çš„åˆ†æ, å¤§è‡´äº†è§£äº†`jQuery`çš„æ€»ä½“æ¶æ„, ä»Šå¤©å°±æ¥çœ‹ä¸€ä¸‹éå¸¸é‡è¦çš„çŸ¥è¯†ç‚¹â€”â€”â€”â€”Sizzle


<!-- more -->


## ä¸€ã€æ›´æ–°

------

### [2019-4-21]

#### Changed

- æ”¹è¿›æ–‡ç« æ’ç‰ˆæ ¼å¼

## äºŒã€å‰ç½®

------

### 2.1 æ­£åˆ™

ç”±äºåªåˆ†æå‡ ç§å¸¸ç”¨çš„é€‰æ‹©å™¨çš„å®ç°åŸç†, æ‰€ä»¥éœ€è¦ç‚¹`æ­£åˆ™`èƒ½åŠ›, èµ·ç è¦å¯¹`*`ã€`.`ã€`[]`ã€`åˆ†ç»„åŒ¹é…`ã€`?:x`ç­‰...äº†å¦‚æŒ‡æŒ.

## ä¸‰ã€æ˜¯ä»€ä¹ˆ?

------

### 3.1 querySelector&querySelectorAll

è¦äº†è§£`Sizzle`çš„`å­˜åœ¨æ„ä¹‰`ä»¥åŠ`åŸç†`, é¦–å…ˆå¾—äº†è§£`querySelector`å’Œ`querySelectorAll`è¿™ä¸¤ä¸ª`API`.

> **Q**: ä»€ä¹ˆæ˜¯`querySelector`&`querySelectorAll`?

***A***: `CSS3`æ–°æ¨å‡ºçš„API.

> **Q**: å®ƒæœ‰ä»€ä¹ˆç”¨?

***A***: ç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„`document.getElementsByTagName`ã€`document.getElementById`æ–¹æ³•, æ¥æ‰§è¡Œ`æ›´å¤æ‚`çš„`DOMé€‰å–`æ“ä½œ.

> **Q**: å¦‚ä½•ä½¿ç”¨å…¶é€‰å–?

***A***: ä¸¤ç§ç”¨é€”(ä»¥`querySelector`ä¸ºä¾‹)

> **Q**: å®ƒçš„å…¼å®¹æ€§å¦‚ä½•?

***A***: æˆªå–äº†`MDN`ä¸Šå¯¹å…¶å…¼å®¹æ€§çš„æè¿°, å¦‚ä¸‹å›¾:

![querySelector&querySelectorAllå…¼å®¹æ€§](/images/1.png)

#### 2.1.1 åŸºæœ¬é€‰æ‹©å™¨

> **PS**: è¾ƒå¸¸ç”¨, æˆ‘åŸºæœ¬åªç”¨åˆ°è¿‡è¿™å‡ ä¸ªğŸ˜„

```ts
document.querySelector('#app');
document.querySelector('.app');
document.querySelector('span')
```

#### 2.1.2 CSS3é€‰æ‹©å™¨

> **PS**: é’ˆå¯¹`CSS3`æ–°æ¨å‡ºçš„è¾ƒä¸ºå¤æ‚ã€é«˜çº§çš„é€‰æ‹©å™¨.

```ts
document.querySelector('p.text span:nth-of-type(2)');
document.querySelector('input[type="radio"]:checked');
```

### 3.2 Sizzle

ä¸Šé¢æåˆ°äº†å…³äº`querySelector`çš„å…¼å®¹æ€§é—®é¢˜, å…¶å®, è¿™å°±æ˜¯`Sizzle`çš„è¯ç”ŸåŸå› :

- è§£å†³ä½ç‰ˆæœ¬IE(`IE8`)ä¸æ”¯æŒ`querySelector`çš„æƒ…å†µ

å®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª`**polyfill**`, é‚£ä¹ˆ:

> **Q**: ä½•æ‰€è°“polyfill?

æˆ‘çš„ç†è§£æ˜¯:

- å®ç°äº†æŸä¸ªæµè§ˆå™¨ä¸æ”¯æŒçš„API

è¿™æ ·ä¸€æ¥, é—®é¢˜å°±æ¸…æ™°å¤šäº†, å…¶å®:

- `Sizzle`å®ç°çš„åŠŸèƒ½å’Œ`document.querySelector`æ˜¯ä¸€æ ·çš„.

## å››ã€ä¸ºä»€ä¹ˆ?

------

> **Q**: ä¸ºä»€ä¹ˆjQueryè¦æä¸€ä¸ª`Sizzle`?

jQueryå°†å¤„ç†é€‰æ‹©å™¨çš„åŠŸèƒ½äº¤ç»™äº†Sizzle, ä¹Ÿæ˜¯ä¸ºäº†æŠ½å–æ ¸å¿ƒé€»è¾‘, ç›®å‰`Sizzle`å·²ç»æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—, å¯ä»¥ä¾›å¼€å‘è€…ä½¿ç”¨äº†.

## äº”ã€æ€ä¹ˆåš?

------

### 5.1 å‡†å¤‡å·¥ä½œ

æºç ä¸­æœ‰å…³`Sizzle`çš„éƒ¨åˆ†æ˜¯ä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°, æ‰€ä»¥å°†å®ƒå•ç‹¬æ‹å‡ºæ¥åˆ°å¤–éƒ¨æ–‡ä»¶, å¤§æ¦‚ä¸¤åƒå¤šè¡Œçš„æ ·å­.

ç”±äºèƒ½åŠ›æœ‰é™, æ‰€ä»¥, åªä¼šç®€å•äº†è§£ä¸€ä¸‹å…¶`å¤§è‡´çš„è¿ä½œåŸç†`å³å¯.

### 5.2 å¦‚ä½•ä½¿ç”¨

æ­£å¼å¼€å§‹ä¹‹å‰, å…ˆæ¥äº†è§£ä¸€ä¸‹`Sizzle`æ˜¯å¦‚ä½•ä½¿ç”¨çš„, ç”±äº`jQuery`å·²ç»å°†å…¶æŠ½ç¦»å‡ºäº†ä¸€ä¸ªå•ç‹¬çš„åº“, æ‰€ä»¥ç›´æ¥å¼•å…¥æµ‹è¯•é¡¹ç›®é›†å°±è¡Œäº†.

åœ¨æµè§ˆå™¨ä¸­å¯ä»¥çœ‹åˆ°:

![å¦‚ä½•ä½¿ç”¨Sizzle.js](/images/2.png)

å¯ä»¥å‘ç°, `Sizzle`è¿”å›äº†åŒ¹é…åˆ°çš„`DOMç»“æœé›†`.

### 5.3 å¤§è‡´ç»“æ„

äº†è§£äº†`Sizzle.js`çš„åŸºç¡€ç”¨æ³•, æ¥ä¸‹æ¥å°±æ˜¯çœ‹æºç äº†.

æˆ‘å°†å…¶æºç åˆ†ä¸ºäº†ä»¥ä¸‹å‡ éƒ¨åˆ†:

> **PS**: æ ‡å‡ºçš„ä½ç½®å‡ä½äº`origin/Sizzle.js`ä¸­, [æ–‡ä»¶åœ°å€](https://github.com/ddzy/my-simple-jquery/blob/branch/dev/origin/Sizzle.js)

```js
/**
 * Sizzle.js
 */


// ç¬¬ä¸€éƒ¨åˆ†: æ­£åˆ™ç»„åˆ(71 - 171)


// ç¬¬äºŒéƒ¨åˆ†: `Sizzle`ä¸»å‡½æ•°(217 - 351)


// ç¬¬ä¸‰éƒ¨åˆ†: `select`é€‰æ‹©å‡½æ•°(2128 - 2196)


// ç¬¬å››éƒ¨åˆ† `compile`ç¼–è¯‘å‡½æ•°(2089 - 2117)


// ç¬¬äº”éƒ¨åˆ† å…¶å®ƒå·¥å…·å‡½æ•°

```

åˆ’åˆ†å¥½äº†`åŸºæœ¬ç»“æ„`, é‚£ä¹ˆæ¥ä¸‹æ¥å°±ç…§ç€å®ƒæ¥è¿›è¡Œä¸‹ä¸€æ­¥â€”â€”`**ç®€å•åˆ†æ**`.

> **PS**: åŠ›è`VS Code`æ’ä»¶â€”â€”`**Bookmarks**`, æºç é˜…è¯»å¿…å¤‡!

- å¸‚åœºæˆªå›¾:

![bookmarksæ’ä»¶åç§°](/images/3.png)

- ä½¿ç”¨æˆªå›¾

![bookmarksæ’ä»¶ä½¿ç”¨](/images/4.png)

### 5.4 ç®€å•åˆ†æ

#### 5.4.1 æ­£åˆ™ç»„åˆ

> **æ€»è§ˆ**: å®šä¹‰ä¸€ç³»åˆ—é’ˆå¯¹`CSS2`ã€`CSS3`é€‰æ‹©å™¨è§„èŒƒçš„`æ ‡å‡†æ­£åˆ™`, ç»„è£…ä¸º`æ­£åˆ™è¡¨è¾¾å¼ç»„`, å¡å…¥`matchExpr`å¯¹è±¡.

å…ˆæ¥æ¢³ç†å‡ ä¸ªé—®é¢˜:

> **Q**: ä½•ä¸º`æ ‡å‡†æ­£åˆ™`?

***A***: è¿™åªæ˜¯æˆ‘å–çš„åå­—, å› ä¸ºå…¶æ ¹æ®`CSS`é€‰æ‹©å™¨è§„èŒƒæ¥æŒ‡å®š.

> **Q**: `ç»„è£…`çš„è¿‡ç¨‹?

***A***: æœ¬è´¨å°±æ˜¯å­—ç¬¦ä¸²çš„æ‹¼æ¥.

> **Q**: CSSé€‰æ‹©å™¨çš„ç§ç±»?

***A***: `idé€‰æ‹©å™¨(#)`ã€`ç±»é€‰æ‹©å™¨(.)`ã€`æ ‡ç­¾é€‰æ‹©å™¨(tag)`ã€`å±æ€§é€‰æ‹©å™¨(input[type=""])`ã€`ä¼ªç±»é€‰æ‹©å™¨(:hoverã€:nth)`ã€`ç»„åˆé€‰æ‹©å™¨(+ã€~ã€>ã€' ')`

æ¥ç€, ç»§ç»­å¾€ä¸‹çœ‹:

> **PS**: ç”±äºä»£ç å¤ªå¤š, å› æ­¤æˆ‘æŒ‘é€‰äº†å‡ ä¸ªè´´å‡ºæ¥

```js
// åŒ¹é…ç©ºç™½å­—ç¬¦
var rwhitespace = /[\x20\t\r\n\f]+/g;
// åŒ¹é…ä»¥`ç»„åˆé€‰æ‹©å™¨`å¼€å¤´çš„å­—ç¬¦ä¸²
var rcombinators = /^[\x20\t\r\n\f]*([>+~]|[\x20\t\r\n\f])[\x20\t\r\n\f]*/;
// æµ‹è¯•é€‰æ‹©å™¨æ˜¯å¦ç¬¦åˆ`CSS`æ ‡å‡†
// http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier
var ridentifier = /^(?:\.|[\w-]|[^\0-\xa0])+$/;

var matchExpr = {
  'ID': /^#((?:\.|[\w-]|[^\0-\xa0])+)/,
  'CLASS': /^\.((?:\.|[\w-]|[^\0-\xa0])+)/,
  'TAG': /^((?:\.|[\w-]|[^\0-\xa0])+|[*])/,
  'ATTR': /\[[\x20\t\r\n\f]*((?:\\.|[\w-]|[^-\xa0])+)(?:[\x20\t\r\n\f]*([*^$|!~]?=)[\x20\t\r\n\f]*(?:'((?:\\.|[^\\'])*)'|"((?:\\.|[^\\"])*)"|((?:\\.|[\w-]|[^-\xa0])+))|)[\x20\t\r\n\f]*\]/,
  "PSEUDO": ...,
  "CHILD": ...,
  ...
};
```

å¯ä»¥çœ‹åˆ°, ç»ˆç©¶æ˜¯å™©æ¢¦èˆ¬çš„æ­£åˆ™, ç‰¹åˆ«æ˜¯`ATTR`, æŠ„éƒ½æŠ„é”™äº†...

ä¸Šè¿°å‡ ä¸ªæ­£åˆ™éƒ½å¯ä»¥ä»å­—é¢æ„æ€ä¸Šçœ‹å‡ºå®ƒä»¬çš„ç”¨é€”, å¹²å·´å·´çš„è¯´å¯èƒ½å¾ˆæ¯ç‡¥, æ‰€ä»¥è¿˜æ˜¯å»`console`è¯•ä¸€ä¸‹æ¯”è¾ƒå¥½

> PS: æˆ‘è¿™é‡Œå°±ä¸è´´`æµ‹è¯•æ­£åˆ™`çš„æˆªå›¾äº†, å¯ä»¥è‡ªè¡Œå°è¯•, æ¯•ç«Ÿä¸åç»­çš„ç¼–è¯‘ç›¸æŒ‚é’©.

æ€»ç»“ä¸€ä¸‹, jQueryé€šè¿‡å®šä¹‰ä¸€ç³»åˆ—`åŒ¹é…CSSé€‰æ‹©å™¨ç±»å‹`çš„æ­£åˆ™, å°†è¯¸å¦‚:

```js
const selector = '#app .post span.text > input[type="text"]';
```

æ­¤ç±»çš„å¤æ‚é€‰æ‹©å™¨æ‹†åˆ†ä¸ºå°çš„`chunk`:

- '#app'
- '&nbsp;&nbsp;'
- '.post'
- '&nbsp;&nbsp;'
- 'span.text'
- '>'
- 'input\[type = "text"\]'

å¯¹äº`chunk`çš„æ“ä½œ, åç»­ä¼šè¯´åˆ°.

#### 5.4.2 Sizzleä¸»å‡½æ•°

> **PS**: æ»¡æ€€æœŸå¾…çš„å®ˆåœ¨ç”µè„‘å‰, å‡†å¤‡æ¬£èµ**`æµ·å†›70å‘¨å¹´åº†`**, ç»“æœ...å¬è¯´æ˜¯ç”±äºå¤§é›¾å–æ¶ˆäº†ç›´æ’­, å¾ˆå¯æƒœ.

> **PS**: ä½†æ˜¯æ–‡ç« ä¸èƒ½ä¸å†™, å› ä¸ºä»Šå¤©çš„ä»»åŠ¡è¿˜æœªå®Œæˆ, è¶ç€æœ‰ç²¾åŠ›èµ¶ç´§æŠŠ`Sizzleä¸»å‡½æ•°`ç›¸å…³çš„å†…å®¹å†™ä¸€ä¸‹.

##### 5.4.2.1 debuggerè°ƒè¯•

> PS: å¯¹äºç»å¸¸é˜…è¯»æºç çš„ç å†œæ¥è¯´, çµæ´»çš„åº”ç”¨`DevTools`æ˜¯è‡³å…³é‡è¦çš„, å¯¹äºç®€å•çš„åº“, å¯ä»¥è¿½è¸ª`å˜é‡å¼•ç”¨`ã€`å‡½æ•°å †æ ˆ`ä¿¡æ¯, æ¯”èµ·**å‚»å‚»çš„ç¿»æºç **æ–¹ä¾¿å¤šäº†(`ä½†æ˜¯å¯¹äºå¤§å‹æ¡†æ¶å¹¶ä¸é€‚ç”¨`).

è¿™é‡Œç®€å•æ¼”ç¤ºä¸€ä¸‹:

![æ¼”ç¤ºä½¿ç”¨debuggerè°ƒè¯•](/images/5.gif)

##### 5.4.2.2 å†…éƒ¨é€»è¾‘

ç…§ä¾‹, å…ˆè´´å‡ºä¸€éƒ¨åˆ†`æ¯”è¾ƒé‡è¦`çš„æºç :

```js
function Sizzle(selector, context, results, seed) {

  // [MARK]: nodeTypeé»˜è®¤æ˜¯`9`, ä¹Ÿå°±æ˜¯`document`
  var nodeType = context ? context.nodeType : 9;
  var results = results || [];

  // [MARK]: å¦‚æœselectorä¸æ˜¯å­—ç¬¦ä¸², ç›´æ¥return
  if(typeof selector !== 'string') {
    return results;
  }

  /**
   * [MARK]: æ£€æµ‹èƒ½å¦ç›´æ¥ä½¿ç”¨åŸç”ŸAPI, åˆ†ä¸¤ç§æƒ…å†µğŸ‘‡
   *
   *    1) å¯¹äºç®€å•çš„å•é€‰æ‹©å™¨
   *      a) getElementById
   *      b) getElementsByTagName
   *      c) getElementsByClassName
   *
   *    2) å¯¹äºå¤æ‚çš„ç»„åˆé€‰æ‹©å™¨
   *      a) querySelectorAll
   */
  if( !seed ) {
    ......
    if(nodeType !== 11 && (
      match = rquickExpr.exec(selector)
    )) {
      // [TODO]: IDé€‰æ‹©å™¨
      if(match[1]) {
        ......
        if(document.getElementById(match[1])) {
          results.push(context.getElementById(match[1]));
          return results;
        }
      }else {
        return results;
      }

      // [TODO]: æ ‡ç­¾é€‰æ‹©å™¨
      else if(
        match[2]
      ) {
        push.apply(results, context.getElementsByTagName( selector ));
        return result;
      }

      // [TODO]: classé€‰æ‹©å™¨
      else if
        match[3]
        && support.getElementsByClassName
        && context.getElementsByClassName
      ) {
        push.apply(results, context.getElementsByClassName( match[3] ));
        return results;
      }
    }
  }

  /**
   * [MARK]: å¦‚æœæ”¯æŒ`querySelectorAll`, ç›´æ¥ä½¿ç”¨å®ƒ
   */
  if(support.qsa) {
    ......
    try {
      push.apply(results, newContext.querySelectorAll( newSelector ))
      return results;
    } catch( qsaError ) {
      // [TODO]: ç–‘é—®â‘ 
      nonnativeSelectorCache( selector, true );
    } finally {
      ......
    }
  }

  // å¯¹äºå…¶å®ƒçš„
  // [TODO]: ç–‘é—®â‘¡
  return select(
    selector.replace( rtrim, '$1' ),
    context,
    results,
    seed,
  );
}
```

ä¸Šè¿°å°±æ˜¯æˆ‘æŠ½å–å‡ºæ¥çš„éƒ¨åˆ†é€»è¾‘ä»£ç , å¯ä»¥çœ‹åˆ°, å…¶å†…éƒ¨ä¸»è¦è¿›è¡Œäº†ä»¥ä¸‹å‡ ç§æ“ä½œ:

1. éæ³•å€¼è¿‡æ»¤
2. ç®€å•é€‰æ‹©å™¨åŒ¹é…
3. querySelectorAllæ£€æµ‹
4. selectä¸»æ“ä½œå‡½æ•°

å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬å…¶å¤„ç†é€»è¾‘:

> èƒ½ç”¨æµè§ˆå™¨**åŸç”ŸAPI**, å°±ä¸ç”¨**Sizzle**äº†

##### 5.4.2.3 ä¸¤ä¸ªç–‘é—®

> **Q**: æºç ä¸­çš„`nonnativeSelectorCache`å‡½æ•°æ˜¯ä»€ä¹ˆ?

***A***: å¯¹åº”`createCache`é—­åŒ…å‡½æ•°, ä¸º`Sizzle`çš„ç¼“å­˜æœºåˆ¶, å°†`selector`ä»¥`Key-value-pair`çš„å½¢å¼å­˜å‚¨äº`createCache`å†…éƒ¨ç»´æŠ¤çš„`keys`æ•°ç»„ä¸­.

> **PS**: `createCache`æºç å¯å‚è€ƒ[è¿™é‡Œ](https://github.com/ddzy/my-simple-jquery/blob/branch/dev/origin/Sizzle.js#L359)

> **Q**: æºç ä¸­`select`æ–¹æ³•èµ·ä½•ç§ä½œç”¨?

***A***: ä¸‹ä¸€åŒºå—å†è®®

#### 5.4.3 selectä¸»æ“ä½œå‡½æ•°

#### 5.4.4 filtersè¿‡æ»¤å™¨

#### 5.4.5 tokenizeä»¤ç‰ŒåŒ–

#### 5.4.6 compileç¼–è¯‘å™¨

## å…­ã€æˆ‘å­¦åˆ°äº†

------

### 6.1 æœ‰ç”¨çš„æ­£åˆ™

#### 6.1.1 åŒ¹é…ç©ºç™½å­—ç¬¦

```js
const rwhitespace = /[\x20\t\r\n\f]+/g;
```

#### 6.1.2 åŒ¹é…ç®€å•é€‰æ‹©å™¨

> **PS**: å½¢å¦‚`#app`ã€`.text`ã€`span`ç­‰å•é€‰æ‹©å™¨.

```js
const rsimpleselector = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/;
```

## ä¸ƒã€ç¤ºä¾‹ä»£ç 

------

ç¤ºä¾‹ä»£ç å‚è€ƒ[ä»“åº“åœ°å€](https://github.com/ddzy/my-simple-jquery)